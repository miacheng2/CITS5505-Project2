<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <p>This is the home page</p>
    <p id="currentUser"></p>
    <a href="/login">Login</a>
    <button onclick="logout()">Logout</button>
    <form onsubmit="sendPost()" return false;>
        <h3>Create a new post here:</h3>
        <!-- required means the input box has to have a value before submission. -->
        <input type="text" id="new_post_title" placeholder="Title goes Here~" required />
        <input type="text" id="new_post_content" placeholder="Post content goes Here~" requied />

        <button type="submit" id="post_btn" disabled>Post post</button>
        <button type="submit" id="deletePost_btn">Delete post</button>
        <p id="login_warning">You have to login to Post! </p>
    </form>

    <div id="postsBox"></div>

</body>

<script>
    // When the page is loaded, do following things
    window.onload = function () {
        var jwtToken = localStorage.getItem("token")
        var userId = localStorage.getItem("userId")
        var userName = localStorage.getItem("userName")


        if (jwtToken != null || jwtToken != undefined) {
            document.getElementById("post_btn").disabled = false;
            document.getElementById("login_warning").style.display = "none";
            document.getElementById("currentUser").innerHTML = "Hi," + userName

            var apiAddress = window.location.hostname
            if (apiAddress == "") {
                apiAddress = "127.0.0.1"
            }
            fetch('http://' + apiAddress + ':5000/getPosts', {
                method: 'GET',
                headers: {
                    // Pass the local JWT tocken to the backend
                    'Authorization': `Bearer ${jwtToken}`,
                    'Content-Type': 'application/json'
                },
            })
                .then(response => {
                    return response.json().then(data => {
                        return { status: response.status, data: data };
                    });
                })
                .then(result => {
                    if (result.status === 200) {
                        console.log('Success:', result.data.post);
                        for (var i = 0; i < result.data.post.length; i++) {
                            var temp_input = '<input type="text" id=' + result.data.post[i].id + ' placeholder="Comment Here~" required/>'
                            var temp_btn = '<button type="submit">Post Comment</button>'
                            if (result.data.post[i].authorName == userName) {
                                var temp_deletePost = '<button onclick="deletePost(' + result.data.post[i].id + ')">Delete Post</button>';
                            }
                            else {
                                var temp_deletePost = "";
                            }
                            var temp_content = '<h2>' + result.data.post[i].authorName + ' posted on: ' + result.data.post[i].date + ', Said: ' + result.data.post[i].title + '</h2><h5>' + result.data.post[i].content + '</h5>' + temp_deletePost;

                            var temp_replys = ''
                            for (var n = 0; n < result.data.post[i].replyData.length; n++) {
                                if (result.data.post[i].replyData[n].authorName == userName) {
                                    var deleteReply_btn = '<button onclick="deleteReply(' + result.data.post[i].replyData[n].id + ')">Delete Reply</button>';
                                }
                                else {
                                    var deleteReply_btn = "";
                                }

                                temp_replys += '<p>At ' + result.data.post[i].replyData[n].date + ' ' + result.data.post[i].replyData[n].authorName + ' commented:</p> <p> ' + result.data.post[i].replyData[n].content + ' </p>' + deleteReply_btn
                            }
                            document.getElementById("postsBox").innerHTML += '<div>' + temp_content + temp_replys + '<form onsubmit="sendReply(' + result.data.post[i].id + '); return false;">' + temp_input + temp_btn + '</form></div>'
                        }

                    } else {
                        console.log("You are not logged in, log in first")
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });

        }
        else {
            console.log("You are not logged in, log in first")
        }

    }


    // 删除帖子的函数
    function deletePost(postId) {
        var jwtToken = localStorage.getItem("token");
        fetch(`/posts/${postId}`, {
            method: 'DELETE', // 使用 DELETE 方法
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.ok) {
                    console.log("Post deleted successfully");
                    window.location.reload(); // 刷新页面以更新内容
                } else {
                    console.error("Failed to delete post");
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // 删除回复的函数
    function deleteReply(replyId) {
        var jwtToken = localStorage.getItem("token");

        fetch(`/replies/${replyId}`, {
            method: 'DELETE', // 使用 DELETE 方法
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }

        })
            .then(response => {
                if (response.ok) {
                    console.log("Reply deleted successfully");
                    window.location.reload(); // 刷新页面以更新内容
                } else {
                    console.error("Failed to delete reply");
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }


    // The following function works for posting the reply.
    function sendReply(replyToPostId) {
        var jwtToken = localStorage.getItem("token")

        const authorId = localStorage.getItem("userId");
        const content = document.getElementById(replyToPostId).value;
        const data = { authorId: authorId, replyToPostId: replyToPostId, content: content };
        // <!--If your flask server is running on different device, your apiAdress should be the remote server address.Otherwise, it should be the loopback address. -->
        var apiAddress = window.location.hostname
        if (apiAddress == "") {
            apiAddress = "127.0.0.1"
        }
        fetch('http://' + apiAddress + ':5000/postReply', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                return response.json().then(data => {
                    return { status: response.status, data: data };
                });
            })
            .then(result => {
                if (result.status === 200) {
                    console.log('Success:', result.data);
                    location.href = "/index";
                } else {
                    console.log('Failed:', result.data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Reply Failed');
            });
    }
    // The following function works for posting the post.
    function sendPost() {
        var jwtToken = localStorage.getItem("token")

        const authorId = localStorage.getItem("userId");
        const title = document.getElementById("new_post_title").value;
        const content = document.getElementById("new_post_content").value;

        const data = { authorId: authorId, title: title, content: content };
        var apiAddress = window.location.hostname
        if (apiAddress == "") {
            apiAddress = "127.0.0.1"
        }

        fetch('http://' + apiAddress + ':5000/postPost', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                return response.json().then(data => {
                    return { status: response.status, data: data };
                });
            })
            .then(result => {
                if (result.status === 200) {
                    console.log('Success:', result.data);
                } else {
                    console.log('Failed:', result.data);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function logout() {

        var jwtToken = localStorage.getItem("token")
        var apiAddress = window.location.hostname
        console.log(jwtToken)

        if (apiAddress == "") {
            apiAddress = "127.0.0.1"
        }

        fetch('/logout', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            },
        })
            .then(response => {
                return response.json().then(data => {
                    return { status: response.status, data: data };
                });
            })
            .then(result => {
                if (result.status === 200) {
                    console.log('Success:', result.data);
                    localStorage.removeItem('token');
                    localStorage.removeItem('userName');
                    localStorage.removeItem('userId');
                    location.href = "./index.html";
                } else {
                    console.log('Failed:', result.data);
                    localStorage.removeItem('token');
                    localStorage.removeItem('userName');
                    localStorage.removeItem('userId');
                    location.href = "/index";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('userName');
                localStorage.removeItem('userId');
                location.href = "/index";
            });
    }

</script>

</html>